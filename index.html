<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Michi Online</title>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-image: url('fondo.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    margin: 0;
    padding: 20px;
}
.board {
    display: grid;
    grid-template-columns: repeat(3, 30vw);
    grid-template-rows: repeat(3, 30vw);
    gap: 2vw;
    margin: 5vw auto;
    max-width: 310px;
}
.cell {
    background-color: rgba(255,255,255,0.5);
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10vw;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.cell.pop { transform: scale(1.2); }

#status { font-size: 22px; margin: 10px 0; }
#scoreboard { font-size: 18px; margin: 10px 0; }

button, select, input {
    padding: 10px 20px;
    font-size: 16px;
    margin: 5px;
}

@media (min-width: 500px) {
    .board {
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
    }
    .cell { font-size: 48px; }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<h1>Juego de Michi</h1>

<div id="status">Selecciona un modo para empezar</div>
<div id="scoreboard">X: 0 | O: 0 | Empates: 0</div>

<button id="vs-machine">Vs Máquina</button>
<button id="vs-friend">Vs Amigo</button>
<button id="vs-online">Online</button>

<br>

<input id="roomCode" placeholder="Código sala">
<button id="createRoom">Crear</button>
<button id="joinRoom">Unirse</button>
<button id="copyCode">Copiar código</button>

<select id="difficulty" style="display:none;">
  <option value="easy">Fácil</option>
  <option value="normal">Normal</option>
  <option value="hard">Extremo</option>
</select>

<div class="board">
  <div class="cell" data-index="0"></div>
  <div class="cell" data-index="1"></div>
  <div class="cell" data-index="2"></div>
  <div class="cell" data-index="3"></div>
  <div class="cell" data-index="4"></div>
  <div class="cell" data-index="5"></div>
  <div class="cell" data-index="6"></div>
  <div class="cell" data-index="7"></div>
  <div class="cell" data-index="8"></div>
</div>

<button id="reset">Reiniciar</button>

<script>
/* FIREBASE - Reemplaza con tu API key real */
firebase.initializeApp({
  apiKey: "TU_API_KEY",  // Cambia esto por tu clave real
  authDomain: "michi-online.firebaseapp.com",
  databaseURL: "https://michi-online-default-rtdb.firebaseio.com",
  projectId: "michi-online"
});
const db = firebase.database();

/* SONIDOS */
const soundX = new Audio("sonidos/jugadaX.mp3");
const soundO = new Audio("sonidos/jugadaO.mp3");
const soundWin = new Audio("sonidos/ganar.mp3");
const soundTie = new Audio("sonidos/empate.mp3");

/* ELEMENTOS */
const cells = document.querySelectorAll('.cell');
const status = document.getElementById('status');
const scoreboard = document.getElementById('scoreboard');
const resetBtn = document.getElementById('reset');
const vsMachineBtn = document.getElementById('vs-machine');
const vsFriendBtn = document.getElementById('vs-friend');
const vsOnlineBtn = document.getElementById('vs-online');
const difficultySelect = document.getElementById('difficulty');
const createRoom = document.getElementById('createRoom');
const joinRoom = document.getElementById('joinRoom');
const roomCode = document.getElementById('roomCode');
const copyCodeBtn = document.getElementById('copyCode');

/* VARIABLES */
let board = Array(9).fill('');
let currentPlayer = 'X';
let gameActive = false;
let vsMachine = false;
let online = false;
let room = null;
let mySymbol = null;

/* MARCADOR */
let scoreX = 0, scoreO = 0, scoreTie = 0;
function updateScore(){
  scoreboard.textContent = `X: ${scoreX} | O: ${scoreO} | Empates: ${scoreTie}`;
}

/* GANADOR */
function checkWinner(b){
  const w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b1,c] of w){
    if(b[a] && b[a]===b[b1] && b[a]===b[c]) return b[a];
  }
  return b.includes('')?null:'tie';
}

/* JUGADA */
function playMove(i,p){
  if(board[i] || !gameActive) return;

  board[i]=p;

  const cell = cells[i];
  cell.textContent=p;
  cell.classList.add('pop');
  setTimeout(()=>cell.classList.remove('pop'),200);

  const audio = (p==='X'?soundX:soundO);
  audio.currentTime=0;
  audio.play();

  const r = checkWinner(board);

  if(r){
    gameActive=false;

    const audioEnd = (r==='tie'?soundTie:soundWin);
    audioEnd.currentTime=0;
    audioEnd.play();

    status.textContent = r==='tie'?'Empate':'Gana '+r;

    if(r==='X') scoreX++;
    else if(r==='O') scoreO++;
    else scoreTie++;

    updateScore();

    if(online){
      db.ref('rooms/'+room).update({
        board: board,
        winner: r
      });
    }

  } else {

    currentPlayer = p==='X'?'O':'X';

    if(online){
      db.ref('rooms/'+room).update({
        board: board,
        currentPlayer: currentPlayer
      });
    }

    status.textContent='Turno '+currentPlayer;

    if(vsMachine && gameActive) aiMove();
  }
}

/* CLICK */
cells.forEach(c=>{
  c.onclick = e=>{
    if(!gameActive) return;
    if(online && currentPlayer!==mySymbol) return;
    const i = e.target.dataset.index;
    playMove(i,currentPlayer);
  }
});

/* IA COMPLETA */
function aiMove(){
  if(!vsMachine || currentPlayer!=='O' || !gameActive) return;
  let move;
  const level = difficultySelect.value;
  if(level==='easy') move=randomMove();
  else if(level==='normal') move = Math.random()<0.6?bestMove():randomMove();
  else move = bestMove();
  setTimeout(()=>playMove(move,'O'),400);
}

function randomMove(){
  const e=board.map((v,i)=>v===''?i:null).filter(v=>v!==null);
  return e[Math.floor(Math.random()*e.length)];
}

function bestMove(){
  let best=-Infinity,m;
  for(let i=0;i<9;i++){
    if(board[i]===''){
      board[i]='O';
      let s=minimax(board,0,false);
      board[i]='';
      if(s>best){best=s; m=i;}
    }
  }
  return m;
}

function minimax(b,d,isMax){
  const r = checkWinner(b);
  if(r==='O') return 10-d;
  if(r==='X') return d-10;
  if(r==='tie') return 0;

  if(isMax){
    let best=-Infinity;
    for(let i=0;i<9;i++){
      if(b[i]===''){
        b[i]='O';
        best=Math.max(best,minimax(b,d+1,false));
        b[i]='';
      }
    }
    return best;
  } else {
    let best=Infinity;
    for(let i=0;i<9;i++){
      if(b[i]===''){
        b[i]='X';
        best=Math.min(best,minimax(b,d+1,true));
        b[i]='';
      }
    }
    return best;
  }
}

/* ONLINE */
function code(){ return Math.random().toString(36).substr(2,4).toUpperCase(); }

vsOnlineBtn.onclick = ()=>{
  resetGame();
  online=true;
  gameActive=true;
  status.textContent='Online: crea o únete';
};

createRoom.onclick = ()=>{
  room = code();
  mySymbol='X';
  const firstPlayer = Math.random() < 0.5 ? 'X' : 'O';  // Turno aleatorio
  db.ref('rooms/'+room).set({
    board: board,
    currentPlayer: firstPlayer,
    winner: null,
    players: {X: true}
  });
  listen();
  status.textContent='Sala '+room+' (X)';
  roomCode.value=room;
};

joinRoom.onclick = ()=>{
  room = roomCode.value.trim().toUpperCase();
  if(!room) return alert('Código inválido');
  mySymbol='O';
  db.ref('rooms/'+room).once('value', snap => {
    if(!snap.val()) return alert('Sala no existe');
    const data = snap.val();
    if(data.players && data.players.O) return alert('Sala llena');
    db.ref('rooms/'+room+'/players/O').set(true);
  });
  listen();
  status.textContent='Unido a '+room+' (O)';
};

copyCodeBtn.onclick = ()=>{
  if(!room) return alert('No hay sala activa');
  navigator.clipboard.writeText(room);
};

function listen(){
  db.ref('rooms/'+room).on('value', snap => {
    if(!snap.val()) return;
    const data = snap.val();
    board = data.board || Array(9).fill('');
    currentPlayer = data.currentPlayer || 'X';
    const winner = data.winner;

    cells.forEach((c,i)=>c.textContent=board[i]);

    if(winner){
      gameActive=false;
      status.textContent = winner==='tie'?'Empate':'Gana '+winner;
      return;
    }

    if(currentPlayer===mySymbol){
      status.textContent='Tu turno';
    } else {
      status.textContent='Esperando al otro jugador...';
    }
  });
}

/* CONTROLES */
vsMachineBtn.onclick = ()=>{
  resetGame();
  vsMachine=true;
  gameActive=true;
  difficultySelect.style.display='inline';
  status.textContent='Turno X';
};

vsFriendBtn.onclick = ()=>{
  resetGame();
  gameActive=true;
  status.textContent='Turno X';
};

resetBtn.onclick = ()=>{
  resetGame();
  if(online && room){
    db.ref('rooms/'+room).update({
      board: board,
      currentPlayer: 'X',
      winner: null
    });
  }
};

function resetGame(){
  board.fill('');
  cells.forEach(c=>c.textContent='');
  gameActive=false;
  vsMachine=false;
  online=false;
  room=null;
  mySymbol=null;
  difficultySelect.style.display='none';
  status.textContent='Selecciona modo';
  // No resetea el marcador global, solo el tablero
}
</script>

</body>
</html>
